import heapq
import math

import numpy as np
from matplotlib import pyplot as plt
from mpl_toolkits.mplot3d.art3d import Line3DCollection, Poly3DCollection

from helper_functions import get_extruded_wedges, fibonacci_sphere_angles
from spatial3R_ftw_draw import generate_square_grid


def track_top_5():
    top_5 = []  # Min heap to keep track of top-5 numbers with indices and properties

    def update(num, index, property_value):
        if len(top_5) < 5:
            heapq.heappush(top_5, (num, index, property_value))
        else:
            heapq.heappushpop(top_5, (num, index, property_value))  # Maintain only top-5

    def get_top_5():
        return sorted(top_5, key=lambda x: x[0], reverse=True)  # Return sorted top-5 list

    return update, get_top_5


"""

# Example usage:
update_top_5, get_top_5 = track_top_5()

for index, (num, prop) in enumerate(
        [(10, 'A'), (3, 'B'), (5, 'C'), (8, 'D'), (20, 'E'), (15, 'F'), (7, 'G'), (25, 'H'), (30, 'I'), (1, 'J')]):
    update_top_5(num, index, prop)

print(get_top_5())  # Output: Top 5 highest numbers with their indices and properties sorted
"""


def plot_bar_graph_transposed_same_color(theta_phi_list, ranges_list):
    """
    Plots a transposed bar graph where the vertical axis represents (theta, phi) tuples,
    and the horizontal bars represent disjoint ranges from -π to π, using the same color.

    Parameters:
    - theta_phi_list: List of tuples (theta, phi) defining categories.
    - ranges_list: List of corresponding range lists in [[[x1, x2], [y1, y2]], ...] format.

    Example:
    theta_phi_list = [(1, 0.5), (2, 1), (3, 1.5), ...]
    ranges_list = [[[1, 2], [3, 4]], [[0, np.pi], [np.pi, 2*np.pi]], ...]
    plot_bar_graph_transposed_same_color(theta_phi_list, ranges_list)
    """

    fig, ax = plt.subplots(figsize=(12, 6))
    num_columns = len(theta_phi_list)

    # Control labeling density
    max_labels = 20
    step = max(1, math.ceil(num_columns / max_labels))  # Avoid division by zero

    # Generate x-labels with controlled density
    x_labels = [f"({theta:.2f}, {phi:.2f})" if i % step == 0 else "" for i, (theta, phi) in enumerate(theta_phi_list)]
    x_positions = np.arange(num_columns)  # Positions of bars on x-axis

    for i, (x_pos, ranges) in enumerate(zip(x_positions, ranges_list)):
        if ranges:  # Plot bars for valid ranges
            for start, end in ranges:
                ax.bar(x_pos, end - start, bottom=start, align='center', color='gray', edgecolor='black')
        else:  # Draw an empty column as a placeholder
            ax.bar(x_pos, 0, bottom=0, align='center', color='white', edgecolor='black')

    ax.set_ylabel("Range (-π to π)")
    ax.set_xlabel("Theta, Phi Tuples")
    ax.set_xticks(x_positions)
    ax.set_xticklabels(x_labels, rotation=45, ha='right')  # Angled labels for better visibility
    ax.set_ylim(-np.pi, np.pi)
    ax.set_yticks(np.linspace(-np.pi, np.pi, 5))
    ax.set_title("Transposed Bar Graph of (Theta, Phi) Mapping to Ranges (Single Color)")

    plt.grid(axis='y', linestyle='--', alpha=0.6)
    plt.show()


"""

orientation_samples = 64
theta_phi_list = fibonacci_sphere_angles(orientation_samples)
color_list = ['b', 'r', 'g', 'y', 'c']
target=[(24999, 17, [[(-3.141592653589793, 1.3416571868452363), [1.7155376684948465, 3.141592653589793]], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 2.5249145484054685), [2.6933290135593113, 3.141592653589793]], [], [[-3.141592653589793, -0.9511625322287729], [1.2908392257235342, 3.141592653589793]], [(-3.141592653589793, 3.141592653589793)], [], [], [], [(-2.1675317169479333, 0.21283807715557335)], [(-3.141592653589793, 3.141592653589793)], [], [[-3.141592653589793, -1.094913332062603], [1.4034247115822467, 3.141592653589793]], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, -1.503565803893916), (-0.1657795177400503, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [(-1.6648302773965564, 0.20530376201993872)], [(-3.141592653589793, 3.141592653589793)], [], [], []], [[(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, -2.4157721483706407), (-0.6717089284242685, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [[-3.141592653589793, -1.877422377776572], [0.7345892814954689, 3.141592653589793]], [(-3.141592653589793, 3.141592653589793)], [], [], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, -1.0867962047558066), (0.4558563537565195, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, -1.2815877576883352), (0.1740206263279229, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, -0.43502885466157437), (0.2868580644914585, 3.141592653589793)], [], [(-1.3587619259578787, 1.5172324590945085)], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, -0.9731845212576227), (0.7218981569278546, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [(-0.180583884970984, 2.6500483905081045)], [(-3.141592653589793, 3.141592653589793)], [], [], []]), (24966, 6, [[[-3.141592653589793, -1.1373873938761891], [1.3921568248558076, 3.141592653589793]], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], []], [[(-3.141592653589793, -0.7047180760072083), (0.7791105852939135, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [[-3.141592653589793, -3.0792095262645462], (-1.5704145442686737, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [], [], [], [], [], [], [(-3.141592653589793, 1.1177832360317654), [1.8161339340528273, 3.141592653589793]], [], [], []]), (24210, 18, [[(-3.141592653589793, 3.141592653589793)], [(-1.5524068895005663, 0.3726532366775601)], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [(-0.7227131079865468, 0.04958737395334567)], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-2.0161578293725757, 0.22325961415187856)], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [(-1.7275481860862405, 0.16843179706552047)], [[-1.9735715959918572, 2.6005990086988424]], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [(-1.8980842155143323, 0.4569451956350681)], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [(-1.4502546518277815, 0.1916223015403793)], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)]], [[(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, -0.736916821895699), (-0.4193552522227734, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [[-3.141592653589793, 3.141592653589793]], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 0.018451904392906116), (1.7188241548515202, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)]]), (22955, 7, [[], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [[-3.1123198025054393, 1.9283164760499092]], [], [], [], [], [], [], [], [(-2.883907609613479, 2.655239202250973)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], []], [[], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [(-3.141592653589793, 3.141592653589793)], []]), (20183, 30, [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [[-2.2157591192822736, 1.526785451293617]], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [], [], [], []], [[], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [], [], [], [], [], [(-3.141592653589793, 3.141592653589793)], [], [], [], [], [], [], [], [], [], [], []])]
for i in range(5):
    beta_range_to_plot = target[i][2]
    alpha_range_to_plot = target[i][3]
    all_wedge_faces,alpha_range_to_plot = get_extruded_wedges(
        theta_phi_list,
        beta_range_to_plot,
        alpha_range_to_plot,
        samples_per_arc=40,
        extrude_radius=2 * np.pi,
        do_plot=True,
        color=color_list[i]
    )
    plot_bar_graph_transposed_same_color(theta_phi_list, alpha_range_to_plot)

"""
"""
n_z = 12
n_x = 6
max_length = 5.286553237016408
x_range = (0, max_length)  # Range for x-axis
z_range = (-max_length, max_length)  # Range for z-axis
color_list = ['b', 'r', 'g', 'y', 'c']
#index_list_to_color = [17, 6, 18, 7, 30]
index_list_to_color = [17, 7, 18, 6, 16]
grid_squares = generate_square_grid(n_x, n_z, x_range, z_range)
# Plot setup
fig = plt.figure()
ax = fig.add_subplot(111, projection='3d')

# Set plot range
ax.set_xlim([-max_length, max_length])
ax.set_ylim([-max_length, max_length])
ax.set_zlim([-max_length, max_length])
angle_ranges = [[] for _ in range(72)]
index_not_empty = [6, 5, 4,3, 18, 17,16,15, 29,28]
for index in index_not_empty:
    angle_ranges[index] = [-np.pi, np.pi]
# Draw squares only if the angle_ranges[i] is non-empty
for i, square in enumerate(grid_squares):
    color = 'k'
    for j in range(5):
        if i == index_list_to_color[j]:
            color = color_list[j]
    alpha = 0.3
    if angle_ranges[i]:  # Check if the list is non-empty
        alpha = 1.0
        # Plot the square grid directly
    square_poly = Poly3DCollection([square], color=color, alpha=alpha)
    ax.add_collection3d(square_poly)
frame_points = [
    (x_range[0], 0, z_range[0]), (x_range[1], 0, z_range[0]),
    (x_range[1], 0, z_range[1]), (x_range[0], 0, z_range[1]),
    (x_range[0], 0, z_range[0])  # Closing the loop
]

frame = Line3DCollection([frame_points], colors='k', linewidths=2)
ax.add_collection3d(frame)

# Set plot labels and show the plot
ax.set_xlabel('X')
ax.set_ylabel('Y')
ax.set_zlabel('Z')
plt.show()
"""
